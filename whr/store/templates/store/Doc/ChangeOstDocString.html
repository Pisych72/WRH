<script>
 let output=$('#string-ost').html();

function GetSumm(){
let price=$("#idprice").val();
   let kol=$("#idkol").val();
   let nds=$("#idnds").val();
   let summa=price*kol
   let total=summa*((nds/100)+1);
   $("#idsumma").val(summa.toFixed(2));
    $("#idtotal").val(total.toFixed(2));
}

 $("#idprice").keyup(function(){
   GetSumm()
});

$("#idprice").change(function(){
    GetSumm()
});

$("#idkol").keyup(function(){
    GetSumm()
   });

 $("#idkol").change(function(){
    GetSumm()
   });
$("#idnds").keyup(function(){
    GetSumm()
   });

 $("#idnds").change(function(){
    GetSumm()
   });

$('#ost-string-form').on('submit',function(e){
event.preventDefault();
let _id=$('#id_iddoc').val();
let _title=$("#idtitle").val();
let _price=$("#idprice").val();
let _kol=$("#idkol").val();
let _summa=$("#idsumma").val();
let _nds=$("#idnds").val();
let _total=$('#idtotal').val();
let _csr=$("input[name=csrfmiddlewaretoken]").val();

mydata={
id:_id,
title:_title,
price:_price,
kol:_kol,
summa:_summa,
nds:_nds,
total:_total,
csrfmiddlewaretoken:_csr,
}

$.ajax({
url:'/StringOstSave/',
method:"POST",
data:mydata,
dataType:"json",

success:function(data){
x=data.unit_data;
s=data.total;
sn=data.total_nds
console.log(s.summa__sum)

if (data.status==1){
for(i=0;i<x.length;i++){
output +='<tr class="align-middle"><td style="width:40%"> '+ x[i]['title__title']+", " + x[i]['title__izm__title']+'</td>'+
'<td  class="text-end" style="width:10%" >'+ x[i]['price']+'</td>'+
'<td  class="text-end "style="width:10%" >'+ x[i]['kol']+'</td>'+
'<td   class="text-end "style="width:10%" >'+ x[i]['summa']+'</td>'+
'<td   class="text-end " style="width:10%" >'+ x[i]['nds']+'</td>'+
'<td  class="text-end " style="width:10%" >'+ x[i]['summawithnds']+'</td>'+
'<td  class="text-center" colspan=2 ><input data-sid='+x[i].id+' data-update='+x[i].id+' class="btn-nom-update " value="Update" type="image" src="../static/images/edit2.png" style="width:35px;" > '+
'<input data-sid='+x[i].id+' data-del="#" class="btn-nom-delete " value="Update" type="image" src="../static/images/del.png" style="width:35px;" > </td></tr>'
}
itog='<tr style="color:blue"><td colspan=3>Итого:</td> <td class="text-end fixed" id="id_total_summa">'+s+'<td></td><td class="text-end fixed " id="id_total_nds">'+sn+'</td></tr>'
console.log(x);
console.log('saved');
 $('#string-ost').html(output)
 $('#string-ost tr:last').after(itog);
 $("#ost-string-form")[0].reset();
}
}
});
});

//////////////////Изменение даты и номера документа, переход в журнал/////////////////
$('#ost-form2').on('submit',function(e){
event.preventDefault();
let _id=$('#id_iddoc').val();
let _csr=$("input[name=csrfmiddlewaretoken]").val();
let _nomer=$('#id_nomerdoc').val();
let _data=$('#id_datadoc').val();


console.log('Return to Jurnal')


mydata={
id:_id,
nomer:_nomer,
data:_data,
csrfmiddlewaretoken:_csr,
}

$.ajax({
url:'/ReturnToJurnalOst/',
method:"POST",
data:mydata,
dataType:"json",

success:function(data){
if(data.status==1){
console.log('saved record');
location.href=data.url;
}
}
});
});

///////////////////////////Редактирование документа остатков//////////////////////


$('#ost-doc').on('click','.btn-ost-update',function(e){
console.log('Pressed button');
let _id=$(this).attr('data-sid');
let _csr=$("input[name=csrfmiddlewaretoken]").val();
console.log(_id);

mydata={
id:_id,
csrfmiddlewaretoken:_csr,
}

$.ajax({
url:'/EditOstDoc/',
method:"POST",
data:mydata,
dataType:"json",

success:function(data){
if (data.status==1){

console.log('saved');
location.href=data.url
}
}

});
});
</script>